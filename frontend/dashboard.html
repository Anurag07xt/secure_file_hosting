<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WELCOME</title>
<style>
    body { font-family: Arial, sans-serif; padding: 30px; background-color: #f5f5f5; }
    h1 { text-align: center; }
    .container { max-width: 900px; margin: auto; }
    .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, select, button { padding: 10px; margin-top: 10px; width: 100%; }
    button { cursor: pointer; background-color: #4CAF50; border: none; color: white; font-size: 16px; border-radius: 5px; }
    table { width: 100%; margin-top: 15px; border-collapse: collapse; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 12px; }
    th { background-color: #eee; }
    .delete-btn { background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 5px; }
</style>
</head>
<body>

<h1>Dashboard</h1>

<div class="container">

    <!-- Upload Box -->
    <div class="card">
        <h2>Upload File</h2>
        <input type="file" id="fileInput">
        <select id="privacy">
            <option value="public">Public</option>
            <option value="private">Private</option>
        </select>
        <button id="uploadBtn">Upload</button>
    </div>

    <!-- Public Files List -->
    <div class="card">
        <h2>Public Files</h2>
        <table id="publicFilesTable">
            <tr><th>Name</th><th>Download</th></tr>
        </table>
    </div>

    <!-- My Files -->
    <div class="card">
        <h2>My Files</h2>
        <table id="myFilesTable">
            <tr><th>Name</th><th>Download</th><th>Delete</th></tr>
        </table>
    </div>

    <button id="logout">Logout</button>
</div>

<script>
const API = "http://localhost:4000/api"; // Correct backend port
const token = localStorage.getItem("token");

// Redirect to login if not logged in
if (!token) window.location = "login.html";

// Logout
document.getElementById("logout").addEventListener("click", () => {
    localStorage.clear();
    window.location = "login.html";
});

// Upload file
document.getElementById("uploadBtn").addEventListener("click", async () => {
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];
    const privacy = document.getElementById("privacy").value;

    if (!file) return alert("Choose a file first!");

    const formData = new FormData();
    formData.append("file", file);
    formData.append("privacy", privacy);

    try {
        const res = await fetch(`${API}/upload`, {
            method: "POST",
            headers: { "Authorization": "Bearer " + token },
            body: formData
        });
        const data = await res.json();
        if (!res.ok) return alert(data.message || "Upload failed");

        alert("File uploaded successfully!");
        fileInput.value = "";
        loadPublicFiles();
        loadMyFiles();
    } catch (err) {
        console.error(err);
        alert("Error connecting to server");
    }
});

// Load public files
async function loadPublicFiles() {
    try {
        const res = await fetch(`${API}/public-files`);
        const files = await res.json();
        const table = document.getElementById("publicFilesTable");
        table.innerHTML = "<tr><th>Name</th><th>Download</th></tr>";

        files.forEach(f => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${f.originalname}</td>
                <td><a href="${API}/files/${f.id}/download" target="_blank">Download</a></td>
            `;
            table.appendChild(row);
        });
    } catch (err) {
        console.error(err);
    }
}

// Load my files
async function loadMyFiles() {
    try {
        const res = await fetch(`${API}/my-files`, {
            headers: { "Authorization": "Bearer " + token }
        });
        const files = await res.json();
        const table = document.getElementById("myFilesTable");
        table.innerHTML = "<tr><th>Name</th><th>Download</th><th>Delete</th></tr>";

        files.forEach(f => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${f.originalname}</td>
                <td><a href="${API}/files/${f.id}/download" target="_blank">Download</a></td>
                <td><button class="delete-btn">Delete</button></td>
            `;
            table.appendChild(row);

            row.querySelector(".delete-btn").addEventListener("click", async () => {
                if (!confirm("Are you sure you want to delete this file?")) return;

                try {
                    const delRes = await fetch(`${API}/files/${f.id}`, {
                        method: "DELETE",
                        headers: { "Authorization": "Bearer " + token }
                    });
                    const delData = await delRes.json();
                    if (!delRes.ok) return alert(delData.message || "Delete failed");

                    alert("File deleted successfully!");
                    loadPublicFiles();
                    loadMyFiles();
                } catch (err) {
                    console.error(err);
                    alert("Error deleting file");
                }
            });
        });
    } catch (err) {
        console.error(err);
    }
}

// Initial load
loadPublicFiles();
loadMyFiles();
</script>

</body>
</html>
