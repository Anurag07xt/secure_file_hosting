<!-- frontend/myfiles.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>My Files</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial; margin: 30px; }
    .file-box { padding: 10px; border: 1px solid #ccc; margin-bottom: 8px; border-radius: 5px; }
    button { margin-left: 10px; }
  </style>
</head>

<body>
  <h1>My Files</h1>

  <div id="userInfo"></div>
  <br>

  <div id="files">Loading...</div>

  <br>
  <a href="upload.html">Upload</a> |
  <a href="downloads.html">Public Downloads</a> |
  <a href="#" id="logout">Logout</a>

  <script>
    const API = 'http://localhost:4000/api';
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username');

    // Redirect if not logged in
    if (!token) {
      alert("Please login first.");
      window.location = 'login.html';
    }

    // Show user info
    document.getElementById('userInfo').innerText =
      username ? `Logged in as: ${username}` : 'Not logged in';

    // Logout
    document.getElementById('logout').addEventListener('click', () => {
      localStorage.clear();
      window.location = 'login.html';
    });

    // Load user's files
    async function load() {
      try {
        const res = await fetch(API + '/my-files', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const files = await res.json();
        const container = document.getElementById('files');
        container.innerHTML = '';

        if (!res.ok) {
          container.innerText = files.message || "Error loading files.";
          return;
        }

        if (!files.length) {
          container.innerText = 'No files uploaded yet.';
          return;
        }

        files.forEach(f => {
          const div = document.createElement('div');
          div.className = "file-box";
          div.innerHTML = `
            <strong>${f.originalname}</strong> 
            (${Math.round(f.size / 1024)} KB) â€” <em>${f.privacy}</em>
            
            <button class="download" data-id="${f.id}">Download</button>
            <button class="delete" data-id="${f.id}">Delete</button>
          `;
          container.appendChild(div);
        });

      } catch (err) {
        console.error(err);
        document.getElementById('files').innerText = "Failed to load files.";
      }
    }

    // Handle clicks on download + delete buttons
    document.addEventListener('click', async (e) => {

      // DOWNLOAD
      if (e.target.classList.contains('download')) {
        const id = e.target.dataset.id;

        try {
          const res = await fetch(API + `/files/${id}/download`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });

          if (!res.ok) {
            alert("Download failed.");
            return;
          }

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = '';  // let backend decide filename
          document.body.appendChild(a);
          a.click();
          a.remove();

        } catch (err) {
          alert("Error downloading file.");
        }
      }

      // DELETE
      else if (e.target.classList.contains('delete')) {
        const id = e.target.dataset.id;

        if (!confirm("Delete this file?")) return;

        try {
          const res = await fetch(API + `/files/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });

          const data = await res.json();
          alert(data.message || "File deleted.");

          load(); // refresh list

        } catch (err) {
          alert("Error deleting file.");
        }
      }

    });

    load();
  </script>
</body>
</html>
